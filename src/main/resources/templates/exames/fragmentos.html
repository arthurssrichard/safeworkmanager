<main class="container" th:fragment="form(exameDTO, action)">
    <div class="row">
        <form th:object="${exameDTO}" th:action="${action}" method="POST">
            <div class="mb-3">

                <div class="row">
                    <div class="col-6">
                        <label for="nome">Nome</label>
                        <input type="text" th:field="*{nome}" id="nome">

                        <label for="descricao">Descrição</label>
                        <textarea th:field="*{descricao}" id="descricao"></textarea>
                    </div>

                    <div class="col-6">
                        <label for="cargosSelect">Cargos</label>
                        <select id="cargosSelect">
                            <option th:each="cargo : ${cargosList}"
                                    th:value="${cargo.id}"
                                    th:text="${cargo.nome}"
                                    th:data-descricao="${cargo.descricao}"></option>
                        </select>
                        <button type="button" id="addCargoBtn" class="btn btn-secondary mt-2">Adicionar</button>
                        <div id="container-cargos">

                        </div>
                    </div>
                </div>

                <div class="row">
                    <div class="col-2">
                        <button type="button" class="btn btn-secondary" id="newNumerico">+ Item numérico</button><br>
                    </div>
                    <div class="col-2">
                        <button type="button" class="btn btn-secondary" id="newBooleano">+ Item booleano</button><br>
                    </div>
                </div>
                <div id="itensExame" class="row gap-10"></div>

                <input type="hidden" id="cargosIds" th:field="*{cargos}">
                <button type="submit" class="btn btn-primary">Cadastrar</button>

            </div>
        </form>
    </div>
    <script>
        function toggleDado() {
            var tipoDado = document.getElementById('tipoDado').value;
            var valorNumerico = document.getElementById('valor-numerico');
            var valorBooleano = document.getElementById('valor-booleano');

            if (tipoDado === 'NUMERICO') {
                valorNumerico.classList.remove('d-none');
                valorBooleano.classList.add('d-none');
            } else {
                valorNumerico.classList.add('d-none');
                valorBooleano.classList.remove('d-none');
            }
        }

        document.getElementById('newBooleano').addEventListener('click',function(){
            const divItens = document.getElementById('itensExame');
            const novoItem = document.createElement('div');
            const boolDivCount = divItens.getElementsByClassName('item-booleano').length;
            novoItem.innerHTML = `
                            <label for="nome-dado-booleano">Nome do dado</label>
                            <input type="text" name="nomeDadoBooleano[${boolDivCount}]" id="nome-dado-booleano">
                            <label>Resultado esperado (booleano)</label>
                            <select name="resultadoBooleanoEsperado[${boolDivCount}]">
                                <option value="true">Sim</option>
                                <option value="false">Não</option>
                            </select>
                            <button type="button" class="btn btn-danger remove-btn">Remover</button>
                                    `;
            divItens.appendChild(novoItem);
            novoItem.classList.add('p-2','mb-2','bg-light','shadow-sm','rounded','item-booleano');

            // Adiciona o evento de remover para o botão "Remover"
            novoItem.querySelector('.remove-btn').addEventListener('click', function () {
                divItens.removeChild(novoItem);
            });
        });

        document.getElementById('newNumerico').addEventListener('click',function(){
            const divItens = document.getElementById('itensExame');
            const novoItem = document.createElement('div');
            const numDivCount = divItens.getElementsByClassName('item-numerico').length;
            novoItem.innerHTML = `
                            <label for="nome-dado-numerico">Nome do dado</label>
                            <input type="text" name="nomeDadoNumerico[${numDivCount}]" id="nome-dado-numerico">
                            <label for="resultadoNumericoEsperado">Resultado esperado (numérico)</label>
                            <fieldset id="resultadoNumericoEsperado" class="row">
                                <div class="col-6">
                                    <label>Minimo</label>
                                    <input name="minimoEsperado[${numDivCount}]" type="number" step="0.01" min="0" placeholder="Ex: 13">
                                </div>
                                <div class="col-6">
                                    <label>Maximo</label>
                                    <input name="maximoEsperado[${numDivCount}]" type="number" step="0.01" min="0" placeholder="Ex: 16">
                                </div>
                            </fieldset>
                            <button type="button" class="btn btn-danger remove-btn">Remover</button>
                                `;
            divItens.appendChild(novoItem);
            novoItem.classList.add('p-2','mb-2','bg-light','shadow-sm','rounded','item-numerico');

            // Adiciona o evento de remover para o botão "Remover"
            novoItem.querySelector('.remove-btn').addEventListener('click', function () {
                divItens.removeChild(novoItem);
            });
        });

        document.querySelectorAll('.remove-btn').forEach(button => {
            button.addEventListener('click', function () {
                const divItens = document.getElementById('itensExame');
                const div = this.parentElement;
                divItens.removeChild(div);
            });
        });

        document.getElementById('addCargoBtn').addEventListener('click',function(){
            const select = document.getElementById('cargosSelect');
            const containerCargos = document.getElementById('container-cargos');
            const cargoIdsInput = document.getElementById('cargosIds');

            //pegar cargo selecionado
            const selected = select.options[select.selectedIndex];
            const cargoId = selected.value;
            const cargoNome = selected.text;
            const cargoDescricao = selected.getAttribute('data-descricao');

            // ver se ja foi selecionado
            if(containerCargos.querySelector(`span[data-id="${cargoId}"]`)){
                alert('Este cargo já foi adicionado');
                return;
            }

            // criar elemento
            const newCargo = document.createElement('span');
            newCargo.setAttribute('data-id',cargoId);
            newCargo.classList.add('d-block','mb-2');
            newCargo.innerHTML = `
                    <p title="${cargoDescricao}" class="d-inline">${cargoNome}</p>
                    <ion-icon name="trash-outline" class="remove-btn" style="cursor: pointer;"></ion-icon>
            `;

            containerCargos.appendChild(newCargo);

            atualizarCargosIds();
            // Adicionar evento de remover para o cargo de lixeira
            newCargo.querySelector('.remove-btn').addEventListener('click',function(){
               containerCargos.removeChild(newCargo);
               atualizarCargosIds();
            });

            function atualizarCargosIds(){
                const containerCargos = document.getElementById('container-cargos');
                const cargos = containerCargos.querySelectorAll('span[data-id]');

                const cargosIds = Array.from(cargos).map(cargo => cargo.getAttribute('data-id'));
                document.getElementById('cargosIds').value = cargosIds.join(',');
            }
        });
    </script>
</main>